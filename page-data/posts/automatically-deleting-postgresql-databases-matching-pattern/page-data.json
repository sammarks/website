{"componentChunkName":"component---src-templates-page-tsx","path":"/posts/automatically-deleting-postgresql-databases-matching-pattern/","result":{"data":{"markdownRemark":{"parent":{"__typename":"File","relativePath":"posts/automatically-deleting-postgresql-databases-matching-pattern.md","fields":{"gitLogLatestDate":"June 10, 2020"}},"htmlAst":{"type":"root","children":[{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"This is a follow-up to "},{"type":"element","tagName":"a","properties":{"href":"../setting-up-database-connections-knex-jest"},"children":[{"type":"text","value":"Setting up database connections with Knex and Jest."}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["custom-block","block-point"]},"children":[{"type":"element","tagName":"div","properties":{"className":["custom-block-heading"]},"children":[{"type":"text","value":"What’s the point?"}]},{"type":"element","tagName":"div","properties":{"className":["custom-block-body"]},"children":[{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"A common approach to isolating your unit-tests that create records in a database is to create a\ndatabase for each suite or worker process running a suite. If the tests don’t properly clean up\nafter themselves every single time, this could result in a lot of unused databases. Let’s remove\nthem automatically."}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"In the previous article, we worked on setting up database connections with Knex and Jest. Basically, we created an environment that spins up a new database at the start of each Jest worker, truncates it after each test, and destroys it after all of the tests have been run."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"The problem with this approach is sometimes tests fail, or you cancel the execution of the suite. When this happens, sometimes the suite isn’t cleaned up properly and that database lingers around. This is annoying because now whenever you login to your database manager to query for some juicy data, you’ve got all of these extra databases sitting around wasting valuable screen space."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"So, let’s get rid of them!"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Since the script we wrote just generates UUIDs as the names of the test databases, we should be able to just delete all databases where their name matches a UUID regex. So all we need is a script to query PostgreSQL for the current list of databases, filter that list based on the UUID regex, and then delete each database."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["custom-block","block-warning"]},"children":[{"type":"element","tagName":"div","properties":{"className":["custom-block-heading"]},"children":[{"type":"element","tagName":"icon-warning","properties":{},"children":[{"type":"text","value":"This has been written assuming you’re using zsh."}]}]},{"type":"element","tagName":"div","properties":{"className":["custom-block-body"]},"children":[{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Not everyone is using zsh. The script might still work for you without any issue, but you may\nhave to make some modifications to get it working in good ole classic bash."}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"And here is that lovely script:"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"shell"},"children":[{"type":"element","tagName":"pre","properties":{"style":"counter-reset: linenumber NaN","className":["language-shell","line-numbers"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-shell"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","shebang","important"]},"children":[{"type":"text","value":"#!/usr/bin/env zsh"}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","assign-left","variable"]},"children":[{"type":"text","value":"PATTERN"}]},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"="}]},{"type":"element","tagName":"span","properties":{"className":["token","variable"]},"children":[{"type":"text","value":"${2"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":="}]},{"type":"text","value":"'"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"%"}]},{"type":"text","value":"-"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"%"}]},{"type":"text","value":"-"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"%"}]},{"type":"text","value":"-"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"%"}]},{"type":"text","value":"-"},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"%"}]},{"type":"text","value":"'}"}]},{"type":"text","value":"\n\npsql -c "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"copy (select datname from pg_database where datname like '"},{"type":"element","tagName":"span","properties":{"className":["token","variable"]},"children":[{"type":"text","value":"$PATTERN"}]},{"type":"text","value":"') to stdout\""}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"|"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"while"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","builtin","class-name"]},"children":[{"type":"text","value":"read"}]},{"type":"text","value":" line"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":";"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"do"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","builtin","class-name"]},"children":[{"type":"text","value":"echo"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\""},{"type":"element","tagName":"span","properties":{"className":["token","variable"]},"children":[{"type":"text","value":"$line"}]},{"type":"text","value":"\""}]},{"type":"text","value":"\n  dropdb "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\""},{"type":"element","tagName":"span","properties":{"className":["token","variable"]},"children":[{"type":"text","value":"$line"}]},{"type":"text","value":"\""}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"done"}]}]},{"type":"element","tagName":"span","properties":{"ariaHidden":"true","className":["line-numbers-rows"],"style":"white-space: normal; width: auto; left: 0;"},"children":[{"type":"element","tagName":"span","properties":{},"children":[]},{"type":"element","tagName":"span","properties":{},"children":[]},{"type":"element","tagName":"span","properties":{},"children":[]},{"type":"element","tagName":"span","properties":{},"children":[]},{"type":"element","tagName":"span","properties":{},"children":[]},{"type":"element","tagName":"span","properties":{},"children":[]},{"type":"element","tagName":"span","properties":{},"children":[]},{"type":"element","tagName":"span","properties":{},"children":[]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"And that’s it! It’s a pretty simple little script."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"First, we define the pattern (this will use the "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"like"}]},{"type":"text","value":" operator inside PostgreSQL) to look for a string with 4 groups of characters, separated by a dash. That will definitely match any valid UUID."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"We then run a query to list the database names from PostgreSQL that match the pattern, and then call the "},{"type":"element","tagName":"a","properties":{"href":"https://www.postgresql.org/docs/9.1/app-dropdb.html","target":"_blank","rel":["noopener"]},"children":[{"type":"text","value":"dropdb"}]},{"type":"text","value":" command on them. This command comes with any standard PostgreSQL installation, so luckily we don’t need to write any extra query magic!"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Before dropping the database, I just echo the name of the database so I’m aware of what I’m dropping."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"But there’s a problem."}]},{"type":"text","value":" I probably want to be able to approve the names of the databases that are being dropped before performing the operation, so I don’t accidentally remove something that I don’t mean to. So let’s update the script to accomplish this:"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"shell"},"children":[{"type":"element","tagName":"pre","properties":{"style":"counter-reset: linenumber NaN","className":["language-shell","line-numbers"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-shell"]},"children":[{"type":"text","value":"psql -c "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"copy (select datname from pg_database where datname like '"},{"type":"element","tagName":"span","properties":{"className":["token","variable"]},"children":[{"type":"text","value":"$PATTERN"}]},{"type":"text","value":"') to stdout\""}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"|"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"while"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","builtin","class-name"]},"children":[{"type":"text","value":"read"}]},{"type":"text","value":" line"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":";"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"do"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","builtin","class-name"]},"children":[{"type":"text","value":"echo"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\""},{"type":"element","tagName":"span","properties":{"className":["token","variable"]},"children":[{"type":"text","value":"$line"}]},{"type":"text","value":"\""}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["gatsby-highlight-code-line"]},"children":[{"type":"text","value":"  "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"if"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"["}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\""},{"type":"element","tagName":"span","properties":{"className":["token","variable"]},"children":[{"type":"text","value":"$1"}]},{"type":"text","value":"\""}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"="}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"yes\""}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"]"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":";"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"then"}]}]},{"type":"element","tagName":"span","properties":{"className":["gatsby-highlight-code-line"]},"children":[{"type":"text","value":"    dropdb "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\""},{"type":"element","tagName":"span","properties":{"className":["token","variable"]},"children":[{"type":"text","value":"$line"}]},{"type":"text","value":"\""}]}]},{"type":"element","tagName":"span","properties":{"className":["gatsby-highlight-code-line"]},"children":[{"type":"text","value":"  "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"fi"}]}]},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"done"}]}]},{"type":"element","tagName":"span","properties":{"ariaHidden":"true","className":["line-numbers-rows"],"style":"white-space: normal; width: auto; left: 0;"},"children":[{"type":"element","tagName":"span","properties":{},"children":[]},{"type":"element","tagName":"span","properties":{},"children":[]},{"type":"element","tagName":"span","properties":{},"children":[]},{"type":"element","tagName":"span","properties":{},"children":[]},{"type":"element","tagName":"span","properties":{},"children":[]},{"type":"element","tagName":"span","properties":{},"children":[]},{"type":"element","tagName":"span","properties":{},"children":[]},{"type":"element","tagName":"span","properties":{},"children":[]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Now, the script only actually drops the databases whenever you call it with “yes” after the name of the command. This means you can call it by itself first, verify the list of databases it’s going to delete, and then call it again with the “yes” argument."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["custom-block","block-info"]},"children":[{"type":"element","tagName":"div","properties":{"className":["custom-block-body"]},"children":[{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"I opted to use the “yes” argument instead of confirming after every single database because there\ncould potentially be a very large list of databases depending on how long it’s been since you\nlast ran the command."}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Okay! So take that fancy script, and put it somewhere on your machine where you’ll be able to remember where to call it. For me, I put it in "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"/usr/local/bin/cleandbs"}]},{"type":"text","value":"."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Make sure to also give it execution permissions!"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"bash"},"children":[{"type":"element","tagName":"pre","properties":{"style":"counter-reset: linenumber NaN","className":["language-bash","line-numbers"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-bash"]},"children":[{"type":"element","tagName":"span","properties":{"className":["command-line-prompt"]},"children":[{"type":"element","tagName":"span","properties":{"dataUser":"root","dataHost":"localhost"},"children":[]}]},{"type":"element","tagName":"span","properties":{"className":["token","function"]},"children":[{"type":"text","value":"chmod"}]},{"type":"text","value":" a+x /usr/local/bin/cleandbs"}]},{"type":"element","tagName":"span","properties":{"ariaHidden":"true","className":["line-numbers-rows"],"style":"white-space: normal; width: auto; left: 0;"},"children":[{"type":"element","tagName":"span","properties":{},"children":[]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Then, to get the list of databases the script will delete "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"(but not actually delete them),"}]},{"type":"text","value":" just run "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"cleandbs"}]},{"type":"text","value":" in your terminal. Review the list, make sure it’s not going to delete anything crazy, and then run "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"cleandbs yes"}]},{"type":"text","value":" to actually delete them."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"If you notice that the script is trying to delete databases you’re wanting to keep, try adjusting the "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"PATTERN"}]},{"type":"text","value":" variable inside the script to be something more appropriate."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["custom-block","block-success"]},"children":[{"type":"element","tagName":"div","properties":{"className":["custom-block-heading"]},"children":[{"type":"element","tagName":"icon-success","properties":{},"children":[{"type":"text","value":"You’ve done it!"}]}]},{"type":"element","tagName":"div","properties":{"className":["custom-block-body"]},"children":[{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Now you’ve got a quick little script you can call every time you want to clean up your databases.\nYou could even register it as a cron job to have it run automatically every week to make sure\nyour list of local databases is "},{"type":"element","tagName":"em","properties":{},"children":[{"type":"text","value":"always"}]},{"type":"text","value":" clean."}]}]}]}],"data":{"quirksMode":false}},"fields":{"slug":"/posts/automatically-deleting-postgresql-databases-matching-pattern/","socialImagePath":"/meta-images/posts/automatically-deleting-postgresql-databases-matching-pattern.png"},"frontmatter":{"title":"Automatically deleting PostgreSQL databases matching a pattern.","summary":"Create a simple bash script to query PostgreSQL for a list of databases matching a specific pattern, and delete them automatically.","date":"2020-06-10"}}},"pageContext":{"slug":"/posts/automatically-deleting-postgresql-databases-matching-pattern/"}}}